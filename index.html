<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>kaenenGPT</title>
<style>
:root {
  --blur: blur(12px);
  --glass: rgba(255,255,255,.06);
  --glass-strong: rgba(255,255,255,.12);
  --accent: #ffffff;
  --send-btn-color: rgba(255,255,255,0.2);
}
* { box-sizing: border-box; margin:0; padding:0; }
body {
  width: 100vw;
  height: 100vh;
  overflow: hidden;
  background: #000;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-end;
}

/* ---------- canvas ---------- */
#spaceCanvas { position: fixed; inset:0; width:100%; height:100%; z-index:0; }

/* ---------- logo ---------- */
#logo {
  position: fixed;
  top: 24px;
  left: 24px;
  font-weight: bold;
  color: rgba(255,255,255,0.9);
  font-size: 20px;
  display: none;
  z-index: 10;
}

/* ---------- settings ---------- */
#settingsBtn {
  position: fixed;
  top: 24px;
  right: 24px;
  width: 32px;
  height: 32px;
  border: 1px solid var(--glass-strong);
  border-radius: 50%;
  background: var(--glass);
  backdrop-filter: var(--blur);
  cursor: pointer;
  z-index: 10;
}
#settingsPanel {
  position: fixed;
  top: 70px;
  right: 24px;
  width: 220px;
  padding: 20px;
  background: rgba(0,0,0,.5);
  border: 1px solid var(--glass-strong);
  border-radius: 12px;
  color: #fff;
  font-size: 13px;
  display: none;
  z-index: 10;
  backdrop-filter: var(--blur);
}
#settingsPanel label { display:flex; align-items:center; margin:10px 0; }
#settingsPanel input[type="checkbox"] { margin-right:8px; }

/* ---------- chat ---------- */
#chatBox {
  width: min(680px, 92vw);
  flex: 1;
  overflow-y: auto;
  margin-bottom: 16px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  z-index:5;
  padding-top:16px;
}
.bubble {
  max-width: 75%;
  padding: 12px 16px;
  border-radius:12px;
  backdrop-filter: var(--blur);
  word-wrap: break-word;
  font-size:15px;
  line-height:1.4;
}
.user { align-self: flex-end; background: var(--glass-strong); color: #fff; }
.ai   { align-self: flex-start; background: var(--glass); color: #fff; }

/* ---------- input ---------- */
#inputRow {
  width: min(680px,92vw);
  margin-bottom:24px;
  display:flex;
  gap:10px;
  z-index:5;
}
#userInput {
  flex:1;
  background: var(--glass);
  border:1px solid var(--glass-strong);
  border-radius:10px;
  padding:14px 16px;
  color:#fff;
  font-size:16px;
  outline:none;
  backdrop-filter: var(--blur);
}
#sendBtn {
  width:48px;
  height:48px;
  background: var(--send-btn-color);
  border:1px solid rgba(255,255,255,0.3);
  border-radius:10px;
  cursor:pointer;
  transition: background .3s;
  z-index:5;
}
#sendBtn.active { background: rgba(0,255,0,0.2); }

/* ---------- canvas improvements ---------- */
</style>
</head>
<body>

<canvas id="spaceCanvas"></canvas>

<!-- logo -->
<div id="logo">kaenengpt</div>

<!-- settings -->
<div id="settingsBtn"></div>
<div id="settingsPanel">
  <label>Background</label>
  <input type="color" id="bgColorPicker" value="#000000" style="width:100%">

  <label><input type="checkbox" id="toggleStars" checked> Stars</label>
  <label>Star speed</label>
  <input type="range" id="starSpeed" min="0.1" max="3" step="0.1" value="1" style="width:100%">

  <!-- NEW SLIDERS -->
  <label>Star size</label>
  <input type="range" id="starSize" min="0.3" max="3" step="0.1" value="1" style="width:100%">
  <label>Sparkle speed</label>
  <input type="range" id="sparkleSpeed" min="0.2" max="4" step="0.1" value="1" style="width:100%">

  <label><input type="checkbox" id="toggleNebulae"> Nebulae</label>
  <label>Nebulae count</label>
  <input type="range" id="nebulaeCount" min="0" max="8" step="1" value="3" style="width:100%">

  <label><input type="checkbox" id="toggleLogo"> Show Logo</label>
</div>

<!-- chat -->
<div id="chatBox"></div>

<!-- input -->
<div id="inputRow">
  <input id="userInput" placeholder="">
  <button id="sendBtn" aria-label="Send"></button>
</div>

<script>
/* ---------- canvas ---------- */
const canvas = document.getElementById('spaceCanvas');
const ctx = canvas.getContext('2d');
let w,h;
function resize() { w=canvas.width=innerWidth; h=canvas.height=innerHeight; }
addEventListener('resize', resize);
resize();

/* ---------- stars ---------- */
const stars = [];
for (let i = 0; i < 200; i++) {
  const angle = Math.random() * Math.PI * 2;
  const speed = 0.2 + Math.random() * 0.8;
  stars.push({
    x: Math.random() * w,
    y: Math.random() * h,
    vx: Math.cos(angle) * speed,
    vy: Math.sin(angle) * speed,
    size: 2 + Math.random() * 4,
    alpha: Math.random(),
    alphaDir: Math.random() < 0.5 ? 1 : -1,
    sparkleBase: 0.015 + Math.random() * 0.015,
    rot: Math.random() * Math.PI * 2
  });
}

let starSpeedMult = 1;
let starSizeMult  = 1;   // size slider
let sparkleMult   = 1;   // sparkle slider

/* diamond-like skinny 4-point star */
function drawStar(ctx, x, y, arm, rot = 0) {
  ctx.save();
  ctx.translate(x, y);
  ctx.rotate(rot);
  const thick = Math.max(0.5, arm * 0.15); // skinnier
  ctx.beginPath();
  // vertical
  ctx.moveTo(-thick, -arm);
  ctx.lineTo( thick, -arm);
  ctx.lineTo( thick,  arm);
  ctx.lineTo(-thick,  arm);
  ctx.closePath(); ctx.fill();
  // horizontal
  ctx.beginPath();
  ctx.moveTo(-arm, -thick);
  ctx.lineTo( arm, -thick);
  ctx.lineTo( arm,  thick);
  ctx.lineTo(-arm,  thick);
  ctx.closePath(); ctx.fill();
  ctx.restore();
}

function drawStars() {
  ctx.save();
  stars.forEach(s => {
    const speed = s.sparkleBase * sparkleMult;
    s.alpha += speed * s.alphaDir;
    if (s.alpha > 1) { s.alpha = 1; s.alphaDir = -1; }
    if (s.alpha < 0) { s.alpha = 0; s.alphaDir = 1; }

    ctx.globalAlpha = s.alpha;
    ctx.fillStyle = '#fff';
    drawStar(ctx, s.x, s.y, s.size * 1.8 * starSizeMult, s.rot);

    s.x += s.vx * starSpeedMult;
    s.y += s.vy * starSpeedMult;
    if (s.x < 0) s.x = w;
    if (s.x > w) s.x = 0;
    if (s.y < 0) s.y = h;
    if (s.y > h) s.y = 0;
  });
  ctx.restore();
}

/* ---------- nebulae ---------- */
const nebulae=[];
function rebuildNebulae(count){
  nebulae.length=0;
  for(let i=0;i<count;i++){
    nebulae.push({
      x:Math.random()*w,
      y:Math.random()*h,
      r:100+Math.random()*200,
      hue:200+Math.random()*220,
      driftX:(Math.random()-0.5)*0.3,
      driftY:(Math.random()-0.5)*0.3
    });
  }
}
rebuildNebulae(3);
function drawNebulae(){
  nebulae.forEach(n=>{
    const grad=ctx.createRadialGradient(n.x,n.y,0,n.x,n.y,n.r);
    grad.addColorStop(0,`hsla(${n.hue},80%,50%,0.15)`);
    grad.addColorStop(0.5,`hsla(${n.hue},60%,50%,0.05)`);
    grad.addColorStop(1,'transparent');
    ctx.fillStyle=grad;
    ctx.beginPath();
    ctx.arc(n.x,n.y,n.r,0,Math.PI*2);
    ctx.fill();
    n.x+=n.driftX; n.y+=n.driftY;
    if(n.x<-n.r)n.x=w+n.r; if(n.x>w+n.r)n.x=-n.r;
    if(n.y<-n.r)n.y=h+n.r; if(n.y>h+n.r)n.y=-n.r;
  });
}

/* ---------- animation ---------- */
let starsEnabled=true;
let nebulaeEnabled=false;
function animate(){
  ctx.clearRect(0,0,w,h);
  if(nebulaeEnabled) drawNebulae();
  if(starsEnabled) drawStars();
  requestAnimationFrame(animate);
}
animate();

/* ---------- settings ---------- */
const panel=document.getElementById('settingsPanel');
document.getElementById('settingsBtn').onclick=()=>{panel.style.display=panel.style.display==='block'?'none':'block';};
document.getElementById('toggleStars').onchange=e=>starsEnabled=e.target.checked;
document.getElementById('toggleNebulae').onchange=e=>nebulaeEnabled=e.target.checked;
document.getElementById('bgColorPicker').oninput=e=>document.body.style.background=e.target.value;
document.getElementById('starSpeed').oninput=e=>starSpeedMult=parseFloat(e.target.value);
document.getElementById('starSize').oninput=e=>starSizeMult=parseFloat(e.target.value);
document.getElementById('sparkleSpeed').oninput=e=>sparkleMult=parseFloat(e.target.value);
document.getElementById('nebulaeCount').oninput=e=>rebuildNebulae(parseInt(e.target.value,10));

const logo=document.getElementById('logo');
document.getElementById('toggleLogo').onchange=e=>{logo.style.display=e.target.checked?'block':'none';};

/* ---------- chat ---------- */
const chatBox=document.getElementById('chatBox');
const userInput=document.getElementById('userInput');
const sendBtn=document.getElementById('sendBtn');

function addBubble(text,sender){
  const div=document.createElement('div');
  div.className='bubble '+sender;
  div.textContent=text;
  chatBox.appendChild(div);
  chatBox.scrollTop=chatBox.scrollHeight;
}

async function sendMsg(){
  const text=userInput.value.trim();
  if(!text) return;
  userInput.value='';
  addBubble(text,'user');

  // thinking placeholder
  const thinkingBubble=document.createElement('div');
  thinkingBubble.className='bubble ai';
  thinkingBubble.textContent='kaenengpt is thinking...';
  chatBox.appendChild(thinkingBubble);
  chatBox.scrollTop=chatBox.scrollHeight;

  // send button flash
  sendBtn.classList.add('active');
  setTimeout(()=>sendBtn.classList.remove('active'),300);

  try{
    const res=await fetch('/.netlify/functions/chat',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({message:text})
    });
    const data=await res.json();
    const replyText=(data && data.reply)?data.reply:'[no reply]';
    thinkingBubble.textContent=replyText;
    chatBox.scrollTop=chatBox.scrollHeight;
  }catch(e){
    thinkingBubble.textContent='[error fetching reply]';
  }
}

sendBtn.addEventListener('click',sendMsg);
userInput.addEventListener('keydown',e=>{if(e.key==='Enter')sendMsg();});
</script>
</body>
</html>
